# Integration Checklist

Pre-flight checklist for adding a new service integration.

---

## Phase 0: Gather Requirements

### Service Information

- [ ] Service name (lowercase): `_______________`
- [ ] Service docs URL: `_______________`
- [ ] API base URL: `_______________`
- [ ] Webhook docs URL: `_______________`

### Credentials Needed

- [ ] Workspace/Org ID: `_______________`
- [ ] API Token/Key: `_______________`
- [ ] OAuth Client ID (if OAuth): `_______________`
- [ ] OAuth Client Secret (if OAuth): `_______________`
- [ ] Webhook Secret: `_______________`

### Webhook Events

List the events you want to receive:

- [ ] Event 1: `_______________`
- [ ] Event 2: `_______________`
- [ ] Event 3: `_______________`
- [ ] Event 4: `_______________`

### Signature Verification

- [ ] Signature header name: `_______________`
- [ ] Signature algorithm: `_______________` (usually HMAC-SHA256)
- [ ] Payload format: `_______________` (JSON, form-data, etc.)

---

## Phase 1: Genesis Key

File: `mentu-ai/.mentu/genesis.key`

- [ ] Read current file
- [ ] Add `signal:{service}` actor under `permissions.actors`
- [ ] Set role: `service`
- [ ] Set operations: `[capture, annotate]`
- [ ] Verify YAML syntax is valid

```yaml
"signal:{service}":
  role: "service"
  operations: [capture, annotate]
```

---

## Phase 2: Config Integration

File: `mentu-ai/.mentu/config.yaml`

- [ ] Add `{service}` under `integrations`
- [ ] Set `enabled: true`
- [ ] Add `workspace_id` (reference .env variable)
- [ ] Add `webhook_url`: `https://mentu-proxy.affihub.workers.dev/signals/{service}`
- [ ] List all `events` to subscribe
- [ ] Configure `sync.push` behavior
- [ ] Configure `sync.pull` behavior

---

## Phase 3: Workspace .env

File: `/Workspaces/.env`

- [ ] Add section header comment
- [ ] Add `{SERVICE}_WORKSPACE_ID`
- [ ] Add `{SERVICE}_INTEGRATION_TOKEN`
- [ ] Add webhook URL as comment (for reference)
- [ ] Document webhook secret placeholder

```bash
# {Service} Integration
{SERVICE}_WORKSPACE_ID=xxx
{SERVICE}_INTEGRATION_TOKEN=xxx
# Webhook URL: https://mentu-proxy.affihub.workers.dev/signals/{service}
# {SERVICE}_WEBHOOK_SECRET=<set via wrangler>
```

---

## Phase 4: Signal Handler

File: `mentu-proxy/src/{service}-signals.ts`

- [ ] Create new file
- [ ] Define `Env` interface with required secrets
- [ ] Create event transform map (`{SERVICE}_TRANSFORMS`)
- [ ] Implement signature verification function
- [ ] Implement `handle{Service}Signal` function
- [ ] Handle verification request (if service sends one)
- [ ] Generate idempotent `source_key`
- [ ] Forward to Mentu API with `actor: signal:{service}`
- [ ] Return appropriate status codes

### Transform Map Template

```typescript
const {SERVICE}_TRANSFORMS: Record<string, {
  kind: string;
  body: (e: any) => string;
  meta: (e: any) => object;
}> = {
  'event.type': {
    kind: '{service}_event',
    body: (e) => `Description`,
    meta: (e) => ({ key: value }),
  },
};
```

---

## Phase 5: Proxy Routing

File: `mentu-proxy/src/index.ts`

- [ ] Add import for signal handler
- [ ] Add secret to `Env` interface
- [ ] Add route in `/signals/` section

```typescript
if (source === '{service}') {
  return handle{Service}Signal(request, body, env);
}
```

---

## Phase 6: Proxy Manifest

File: `mentu-proxy/.mentu/manifest.yaml`

- [ ] Add `signal-{service}` capability
- [ ] Document inputs (type, payload, etc.)
- [ ] Document outputs (memory_id, source_key)

---

## Phase 7: Wrangler Config

File: `mentu-proxy/wrangler.toml`

- [ ] Add secret requirement comment

```toml
# - {SERVICE}_WEBHOOK_SECRET: {Service} webhook signature secret
```

---

## Phase 8: Deploy

```bash
cd mentu-proxy
```

- [ ] Run `npm run build` - verify no errors
- [ ] Run `wrangler secret put {SERVICE}_WEBHOOK_SECRET`
- [ ] Enter the webhook secret value
- [ ] Run `wrangler deploy`
- [ ] Verify deployment succeeded

---

## Phase 9: External Configuration

In {Service}'s settings/developer portal:

- [ ] Navigate to webhook/integration settings
- [ ] Create new webhook subscription
- [ ] Set URL: `https://mentu-proxy.affihub.workers.dev/signals/{service}`
- [ ] Select API version (latest stable)
- [ ] Select events from your list
- [ ] Copy webhook secret (if generated by service)
- [ ] Save configuration

### Connect to Workspace

- [ ] Add integration/connection to relevant pages/databases/channels
- [ ] Grant necessary permissions (read, write, etc.)

---

## Phase 10: Verification

### Health Check

```bash
curl https://mentu-proxy.affihub.workers.dev/health
```

- [ ] Returns `healthy` status
- [ ] Lists `signals` in services array

### Test Event

- [ ] Create/update something in {Service}
- [ ] Verify no errors in worker logs
- [ ] Check Mentu for new memory:

```bash
mentu list memories --kind {service}_ --limit 5
```

- [ ] Memory exists with correct kind
- [ ] Memory body contains expected data
- [ ] Memory meta has service-specific fields

---

## Phase 11: Documentation

- [ ] Capture integration evidence:

```bash
mentu capture "Added {Service} integration" \
  --kind integration \
  --meta '{"service":"{service}","events":["list","of","events"]}'
```

- [ ] Update this checklist if you discovered additional steps
- [ ] Document any service-specific quirks

---

## Rollback Procedure

If integration fails:

1. Remove route from `mentu-proxy/src/index.ts`
2. Remove signal handler file
3. Redeploy: `wrangler deploy`
4. Remove webhook from {Service} settings
5. Comment out entries in `.env`, `config.yaml`, `genesis.key`

Do NOT delete genesis.key entries - comment them out instead (append-only principle).

---

## Common Issues

### Signature Verification Failed

- Check header name matches service documentation
- Verify algorithm (SHA256 vs SHA1)
- Ensure secret matches between service and wrangler

### 404 on Webhook

- Verify route added to index.ts
- Check signal handler export name matches import
- Redeploy after changes

### No Memory Created

- Check Mentu API key is valid
- Verify workspace ID is correct
- Check transform exists for event type
- Look at worker logs for errors

### Duplicate Prevention Issues

- Ensure `source_key` uses unique identifier (delivery ID, request ID)
- Check idempotency logic in signal handler

---

*Check twice, deploy once. Every integration is a commitment.*
